language: go
go:
  - 1.6

services:
  - docker

os:
  - linux
  - osx

env:
  global:
    - COMMIT=${TRAVIS_COMMIT::8}
    - IMAGE=cardigann/cardigann
    - IMAGE_VERSION=$IMAGE:$COMMIT
    - secure: "Zc1m1W2gfl9dHDPCGh6glqj7QwsCt/f4vuUMQexZMVzuHHxfPAS/+hKbbKPzVN76co73JnXnDa3yMan6Szg4V9qpxP1fG4V5vURfsIjBl2AoQVMT6e2sp2dAV0IHRFtFEuFab4gLAby5lFlwSmWTJS4+w57k3ZGZQbtGlgb1P1fOgScHrWo2yXWa+TLoydsk+F4ET1qC2Ajw6/FQUxfBczFU+xVZ6eHIyeI1n09ORr7enQWU+57MttSi3qojPT+SWtCL+GhLoBFvUB+T7UUotwzPXRkCm7v7A8/LIcn821CP9BKX6q6LB3LN2c//HLi+2qe3ZE/VFOw99Jg6G0YBc44J0YTHl2SHT/NZrZZKYXP1ttzULoF49Ljj4LnLzVqOPPZLD5Ti21NCIDld7frecg6V/qm9NdKAUOZh+KD5QZM/BA2HbF++LpWV40VoopHlK2ablV8n+Y4vscJTKuCXf7yWG4JRjWzKW7eTlxn7ux+3S5Yi1SSlCj3eoAe+CujS0HqU4h+dmQ02IDx6GdYkF7enuXmnD2l/FHsIiWJLtOH91ZFkEPpOGPczcILAzlbDMWNsV338bN+wKMV43lRRcqJju1+4wiYsgY3Q0b8+ia0IfvNv5F1ADJZZiQreWLJQWhvIIQnjBwC/LVaVuoHLQu9TIK4OlCFbNxjmc9dipaE="

script:
  - make test

before_deploy:
  - make build-without-static
  - ./cardigann version
  - docker build --build-arg BIN=./cardigann -t ${IMAGE}:${COMMIT} .
  - docker tag ${IMAGE}:${COMMIT} ${IMAGE}:latest
  - docker tag ${IMAGE}:${COMMIT} ${IMAGE}:travis-${TRAVIS_BUILD_NUMBER}
  - docker login -u="${DOCKER_USERNAME}" -p="${DOCKER_PASSWORD}"

deploy:
  skip_cleanup: true
  provider: script
  script: docker push ${IMAGE}
  on:
    branch:
      - master
      - travis-docker-builds
    condition: $TRAVIS_OS_NAME = linux
